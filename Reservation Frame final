
import javax.swing.*;
import java.awt.*;
import java.io.IOException;

public class ReservationFrame extends JFrame {
    private final Connection connection;
    private final String username;
    private JComboBox<String> libraryCombo;
    private JComboBox<String> topicCombo;
    private DefaultListModel<String> bookModel;
    private JList<String> bookList;
    private JButton btnTopics, btnBooks, btnReserve, btnLogout;

    public ReservationFrame(Connection connection, String username) {
        this.connection = connection;
        this.username = username;

        setTitle("Book Reservation");
        setSize(800, 500);
        setLocationRelativeTo(null);
        setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        setResizable(false);
        buildUI();
        loadLibrariesFromServer();
    }

    private void buildUI() {
        JLabel title = new JLabel("Book Reservation", SwingConstants.CENTER);
        title.setFont(new Font("Segoe UI", Font.BOLD, 22));
        title.setBorder(BorderFactory.createEmptyBorder(15, 0, 20, 0));

        JLabel lblLibrary = new JLabel("Library:");
        lblLibrary.setFont(new Font("Segoe UI", Font.PLAIN, 16));
        JLabel lblTopic = new JLabel("Topic:");
        lblTopic.setFont(new Font("Segoe UI", Font.PLAIN, 16));
        JLabel lblBooks = new JLabel("Available Books");
        lblBooks.setFont(new Font("Segoe UI", Font.BOLD, 15));

        libraryCombo = createStyledComboBox(new String[]{});
        topicCombo = createStyledComboBox(new String[]{});
        bookModel = new DefaultListModel<>();
        bookList = new JList<>(bookModel);
        bookList.setFont(new Font("Segoe UI", Font.PLAIN, 14));
        JScrollPane bookScroll = new JScrollPane(bookList);
        
        bookScroll.setPreferredSize(new Dimension(330, 120)); // ✅ عرض وارتفاع مضبوط مثل السابق
        bookScroll.setMinimumSize(new Dimension(330, 120));
        bookScroll.setBorder(BorderFactory.createTitledBorder(""));


        btnTopics = createStyledButton("Show Topics");
        btnBooks = createStyledButton("Show Books");
        btnReserve = createStyledButton("Reserve");
        btnLogout = createStyledButton("Logout");

        JPanel panel = new JPanel(new GridBagLayout());
        GridBagConstraints c = new GridBagConstraints();
        c.insets = new Insets(8, 10, 8, 10);
        c.anchor = GridBagConstraints.WEST;

        c.gridx = 0; c.gridy = 0;
        panel.add(lblLibrary, c);

        c.gridx = 1; c.gridy = 0;
        panel.add(libraryCombo, c);

        c.gridx = 2; c.gridy = 0;
        c.anchor = GridBagConstraints.CENTER;
        panel.add(lblBooks, c);

        c.gridx = 0; c.gridy = 1;
        c.anchor = GridBagConstraints.WEST;
        panel.add(lblTopic, c);

        c.gridx = 1; c.gridy = 1;
        panel.add(topicCombo, c);

        c.gridx = 2; c.gridy = 1;
        c.gridheight = 2;
        panel.add(bookScroll, c);
        c.gridheight = 1;

        JPanel buttonsPanel = new JPanel(new FlowLayout(FlowLayout.CENTER, 20, 10));
        buttonsPanel.add(btnTopics);
        buttonsPanel.add(btnBooks);
        buttonsPanel.add(btnReserve);
        buttonsPanel.add(btnLogout);

        JPanel root = new JPanel(new BorderLayout());
        root.setBorder(BorderFactory.createEmptyBorder(10, 20, 20, 20));
        root.add(title, BorderLayout.NORTH);
        root.add(panel, BorderLayout.CENTER);
        root.add(buttonsPanel, BorderLayout.SOUTH);

        setContentPane(root);

        btnTopics.addActionListener(e -> loadTopicsForSelectedLibrary());
        btnBooks.addActionListener(e -> loadBooksForSelectedTopic());
        btnReserve.addActionListener(e -> doReserveNow());
        btnLogout.addActionListener(e -> handleLogoutButton());
    }

    private JComboBox<String> createStyledComboBox(String[] items) {
        JComboBox<String> combo = new JComboBox<>(items);
        combo.setPreferredSize(new Dimension(220, 35));
        combo.setFont(new Font("Segoe UI", Font.PLAIN, 14));
        combo.setBackground(Color.WHITE);
        combo.setFocusable(false);
        combo.setBorder(BorderFactory.createLineBorder(new Color(180, 180, 180)));
        return combo;
    }

    private JButton createStyledButton(String text) {
        JButton btn = new JButton(text);
        btn.setFocusPainted(false);
        btn.setBackground(new Color(245, 245, 245));
        btn.setBorder(BorderFactory.createLineBorder(new Color(180, 180, 180)));
        btn.setPreferredSize(new Dimension(140, 36));
        btn.setFont(new Font("Segoe UI", Font.PLAIN, 14));

        btn.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseEntered(java.awt.event.MouseEvent evt) {
                btn.setBackground(new Color(230, 230, 230));
            }
            public void mouseExited(java.awt.event.MouseEvent evt) {
                btn.setBackground(new Color(245, 245, 245));
            }
        });
        return btn;
    }

    private void loadLibrariesFromServer() {
        try {
            String resp = connection.sendRequest("LIBRARIES");
            libraryCombo.removeAllItems();
            if (resp != null && resp.startsWith("LIBRARIES:")) {
                String body = resp.substring("LIBRARIES:".length());
                String[] libs = body.split(",");
                for (String lib : libs) libraryCombo.addItem(lib.trim());
            } else {
                JOptionPane.showMessageDialog(this, "Failed to load libraries.\n" + resp);
            }
        } catch (IOException ex) {
            JOptionPane.showMessageDialog(this, "I/O: " + ex.getMessage());
        }
    }

    private void loadTopicsForSelectedLibrary() {
        try {
            Object sel = libraryCombo.getSelectedItem();
            if (sel == null) return;
            String lib = sel.toString();
            String resp = connection.sendRequest("TOPICS:" + lib);
            topicCombo.removeAllItems();
            if (resp != null && resp.startsWith("TOPICS:")) {
                String[] parts = resp.split(":");
                if (parts.length >= 3) {
                    String[] topics = parts[2].split(",");
                    for (String t : topics) topicCombo.addItem(t.trim());
                }
            } else {
                JOptionPane.showMessageDialog(this, "No topics.\n" + resp);
            }
        } catch (IOException ex) {
            JOptionPane.showMessageDialog(this, "I/O: " + ex.getMessage());
        }
    }

    private void loadBooksForSelectedTopic() {
        try {
            Object l = libraryCombo.getSelectedItem();
            Object t = topicCombo.getSelectedItem();
            if (l == null || t == null) return;
            String resp = connection.sendRequest("BOOKS:" + l + ":" + t);
            bookModel.clear();
            if (resp != null && resp.contains(":NO_BOOKS")) {
                bookModel.addElement("No available books.");
            } else if (resp != null && resp.startsWith("BOOKS:")) {
                String[] parts = resp.split(":");
                if (parts.length >= 4) {
                    String[] books = parts[3].split(",");
                    for (String b : books) bookModel.addElement(b.trim());
                }
            } else {
                JOptionPane.showMessageDialog(this, "Failed to load books.\n" + resp);
            }
        } catch (IOException ex) {
            JOptionPane.showMessageDialog(this, "I/O: " + ex.getMessage());
        }
    }

    private void doReserveNow() {
        try {
            Object l = libraryCombo.getSelectedItem();
            Object t = topicCombo.getSelectedItem();
            String b = bookList.getSelectedValue();
            if (l == null || t == null || b == null) return;
            if (b.startsWith("No available")) return;
            String resp = connection.sendRequest("RESERVE:" + l + ":" + t + ":" + b);
            if ("RESERVED".equals(resp)) {
                JOptionPane.showMessageDialog(this, "Reserved ✓");
                loadBooksForSelectedTopic();
            } else if ("NOT_AVAILABLE".equals(resp)) {
                JOptionPane.showMessageDialog(this, "Already reserved by someone else.");
                loadBooksForSelectedTopic();
            } else {
                JOptionPane.showMessageDialog(this, resp);
            }
        } catch (IOException ex) {
            JOptionPane.showMessageDialog(this, "I/O: " + ex.getMessage());
        }
    }

    private void handleLogoutButton() {
        try {
            connection.closeConnection();
        } catch (Exception ignore) {}
        dispose();
        RegisterFrame rf = new RegisterFrame();
        rf.setVisible(true);
    }
}
